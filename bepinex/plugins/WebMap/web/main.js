(()=>{"use strict";const e={CANVAS_WIDTH:2048,CANVAS_HEIGHT:2048,PIXEL_SIZE:12,EXPLORE_RADIUS:100,DEFAULT_ZOOM:200};e.COORD_OFFSET=e.CANVAS_WIDTH/2;const t=e,n={},i={players:(e,t)=>{const i=t.replace(/^players\n/,"").split("\n\n"),o=[];i.forEach((e=>{const t=e.split("\n"),n={id:t[0],name:t[1],health:parseFloat(t[3]),maxHealth:parseFloat(t[4])};if("hidden"!==t[2]){const e=t[2].split(",").map(parseFloat);n.x=e[0],n.y=e[1],n.z=e[2]}else n.hidden=!0;o.push(n)})),n.players.forEach((e=>{e(o)}))},ping:e=>{const t=e[2].split(","),i={playerId:e[0],name:e[1],x:parseFloat(t[0]),z:parseFloat(t[1])};n.ping.forEach((e=>{e(i)}))},pin:e=>{const t=e[4].split(",").map(parseFloat),i={id:e[1],uid:e[0],type:e[2],name:e[3],x:t[0],z:t[1],text:e[5]};n.pin.forEach((e=>{e(i)}))},rmpin:e=>{n.rmpin.forEach((t=>{t(e[0])}))}};Object.keys(i).forEach((e=>{n[e]=[]}));let o=0;const a=()=>{const e=location.href.split("?")[0].replace(/^http/,"ws"),t=new WebSocket(e);t.addEventListener("message",(e=>{const t=e.data.trim(),n=t.split("\n"),o=n.shift(),a=i[o];a?a(n,t):console.log("unknown websocket message: ",e.data)})),t.addEventListener("open",(()=>{o=0})),t.addEventListener("close",(()=>{o++;const e=Math.min(o*(o+1),120);setTimeout(a,1e3*e)}))},s={init:a,addActionListener:(e,t)=>{const i=n[e]||[];i.push(t),n[e]=i}},d={};document.querySelectorAll("[data-id]").forEach((e=>{d[e.dataset.id]=e}));const l=document.createElement("div"),r=d,{canvas:c,map:p,mapBorder:h,mapBorderCircle:m}=r;let E=t.CANVAS_WIDTH,f=t.CANVAS_HEIGHT,y=t.EXPLORE_RADIUS,u=t.PIXEL_SIZE,L=t.COORD_OFFSET;document.createElement("img").src="mapIcons.png";const x=c.getContext("2d");let v,w;const I=document.createElement("canvas"),g=I.getContext("2d");let A=100;const T=[],_={};let O;const C=e=>{const t=e.el.getBoundingClientRect(),n=window.innerWidth/2-t.left,i=window.innerHeight/2-t.top;(Math.abs(n)>.5||Math.abs(i)>.5)&&(p.style.left=n+p.offsetLeft+"px",p.style.top=i+p.offsetTop+"px")},S=()=>{T.forEach((e=>{let t=!1;e.el||(t=!0,e.el=(e=>{const t=document.createElement("div");t.id=e.id,t.className=`mapText mapIcon ${e.type}`,e.zIndex&&(t.style.zIndex=e.zIndex);const n=document.createElement("div");return n.className="center text",n.textContent=e.text,t.appendChild(n),e.node&&t.appendChild(e.node),t})(e),p.appendChild(e.el));const n=_[e.type];if(e.el.style.display=n?"none":"block",!t&&e.static)return;const i=e.x/u+L,o=f-(e.z/u+L);e.el.style.left=100*i/E+"%",e.el.style.top=100*o/f+"%"})),O&&C(O)};window.addEventListener("mousemove",(e=>{const t=p.offsetWidth/E,n=u*(-L+(e.clientX-p.offsetLeft)/t),i=u*(f-L+(p.offsetTop-e.clientY)/t);r.coords.textContent=`${n.toFixed(2)} , ${i.toFixed(2)}`}));const R=e=>{const t=T.indexOf(e);t>-1&&(T.splice(t,1),e.el&&(e.el.remove(),e.el=void 0))},z=()=>{x.clearRect(0,0,E,f),x.globalCompositeOperation="source-over",x.drawImage(v,0,0),x.globalCompositeOperation="multiply",x.drawImage(I,0,0),S()},D=function(e,t,n){void 0===t&&(t=window.innerWidth/2,n=window.innerHeight/2);const i=A,o=8e3*devicePixelRatio;e=Math.min(Math.max(Math.round(e),50),o),A=e,p.style.width=`${e}%`,p.style.height=p.offsetWidth+"px";const a=A/i;p.style.left=a*(p.offsetLeft-t)+t+"px",p.style.top=a*(p.offsetTop-n)+n+"px",S()};let M;const P=e=>{E=t.CANVAS_WIDTH,f=t.CANVAS_HEIGHT,y=t.EXPLORE_RADIUS,u=t.PIXEL_SIZE,L=t.COORD_OFFSET,c.width=E,c.height=f,p.style.width="100%",p.style.height=p.offsetWidth+"px",p.style.left=(window.innerWidth-p.offsetWidth)/2+"px",p.style.top=(window.innerHeight-p.offsetHeight)/2+"px",I.width=E,I.height=f,g.fillStyle="#ffffff",h.setAttribute("viewBox",`0 0 ${E} ${f}`),m.setAttribute("cx",E/2),m.setAttribute("cy",E/2),m.setAttribute("r",.4275*E),v=e.mapImage,w=e.fogImage,g.drawImage(w,0,0),z();const n=(e,t=1)=>{p.classList.add("zooming");const n=A,i=Math.max(Math.floor(n/5),1)*t,o=0===e.deltaY?e.deltaX:e.deltaY;D(o>0?n-i:n+i,e.clientX,e.clientY),clearTimeout(M),M=setTimeout((()=>{p.classList.remove("zooming")}),100)};e.zoom&&D(e.zoom),window.addEventListener("wheel",n),window.addEventListener("resize",(()=>{p.style.height=p.offsetWidth+"px"}));const i={};let o,a=!1;((e,t)=>{const n=new Map;let i=[];const o=e=>{n.delete(e.pointerId),i=i.filter((t=>t.event.pointerId!==e.pointerId)),t.up&&t.up(i)};e.addEventListener("pointerdown",(e=>{const o={downEvent:e,event:e};n.set(e.pointerId,o),i.push(o),t.down&&t.down(i)})),window.addEventListener("pointermove",(e=>{const o=n.get(e.pointerId);o&&(o.event=e,t.move&&t.move(i))})),window.addEventListener("pointerup",o),window.addEventListener("pointercancel",o)})(window,{down:e=>{1===e.length?(i.x=p.offsetLeft,i.y=p.offsetTop):2===e.length&&(a=!0,o=void 0)},move:e=>{if(1!==e.length||a||O){if(2===e.length){const t=e[0].event.clientX,i=e[0].event.clientY,a=e[1].event.clientX,s=e[1].event.clientY,d=t-a,l=i-s,r=Math.sqrt(d*d+l*l);o&&n({deltaY:o-r||-1,clientX:(t+a)/2,clientY:(i+s)/2},.08),o=r}}else{const t=e[0].event;p.style.left=i.x+(t.clientX-e[0].downEvent.clientX)+"px",p.style.top=i.y+(t.clientY-e[0].downEvent.clientY)+"px",S()}},up:e=>{0===e.length&&(a=!1)}})},N=(e,t=!0)=>{e.id||(e.id=`id_${Date.now()}_${Math.random()}`),T.push(e),t&&S()},b=R,F=(e,t)=>{_[e]=t},H=e=>{O=e,O&&C(O)},W=z,U=S,X={};let $;const k=e=>{$&&$.playerListEntry.el.classList.remove("selected"),e&&e!==$?($=e,$.playerListEntry.el.classList.add("selected"),r.map.classList.remove("smooth"),H(e),r.topMessage.textContent=`Following ${$.name}`,setTimeout((()=>{r.map.classList.add("smooth")}),0)):($=null,H(null),r.map.classList.remove("smooth"),r.topMessage.textContent="")},V=()=>{s.addActionListener("players",(e=>{e.forEach((e=>{let t=X[e.id];if(!t){const n=(e=>{l.innerHTML='\n\t\t\t\t\t<div class="playerListEntry">\n\t\t\t\t\t\t<div class="name" data-id="name"></div>\n\t\t\t\t\t\t<div class="hpBar" data-id="hpBar">\n\t\t\t\t\t\t\t<div class="hp" data-id="hp"></div>\n\t\t\t\t\t\t\t<div class="hpText" data-id="hpText"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t';const t={};return l.querySelectorAll("[data-id]").forEach((e=>{t[e.dataset.id]=e})),{el:l.children[0],ui:t}})();n.ui.name.textContent=e.name,r.playerList.appendChild(n.el),t={...e,type:"player",text:e.name,zIndex:5,playerListEntry:n},e.hidden?n.ui.hpBar.style.display="none":N(t,!1),X[e.id]=t,n.el.addEventListener("click",(()=>{t.hidden||(r.playerListTut&&(r.playerListTut.remove(),r.playerListTut=void 0),k(t))}))}!e.hidden&&t.hidden?(t.hidden=e.hidden,N(t,!1),t.playerListEntry.ui.hpBar.style.display="block"):e.hidden&&!t.hidden&&(t.hidden=e.hidden,b(t),t.playerListEntry.ui.hpBar.style.display="none",$===t&&k(null)),t.lastUpdate=Date.now(),t.x=e.x,t.z=e.z,e.hidden||(t.playerListEntry.ui.hp.style.width=100*Math.max(e.health/e.maxHealth,0)+"%",t.playerListEntry.ui.hpText.textContent=`${Math.round(Math.max(e.health,0))} / ${Math.round(e.maxHealth)}`,((e,t)=>{const n=y/u,i=e/u+L,o=f-(t/u+L);g.beginPath(),g.arc(i,o,n,0,2*Math.PI),g.fill(),z()})(e.x,e.z))})),U()})),setInterval((()=>{const e=Date.now();Object.keys(X).forEach((t=>{const n=X[t];e-n.lastUpdate>5e3&&(b(n),n===$&&k(null),n.playerListEntry.el.remove(),delete X[t])}))}),2e3)},B=document.createElement("img"),Y=document.createElement("img"),Z=fetch("config").then((e=>e.json())).then((e=>{t.CANVAS_WIDTH=e.texture_size||2048,t.CANVAS_HEIGHT=e.texture_size||2048,t.PIXEL_SIZE=e.pixel_size||12,t.EXPLORE_RADIUS=e.explore_radius||100,t.UPDATE_INTERVAL=e.update_interval||.5,t.WORLD_NAME=e.world_name,t.WORLD_START_POSITION=(e=>{const t=e.split(",");return{x:parseFloat(t[0]),y:parseFloat(t[1]),z:parseFloat(t[2])}})(e.world_start_pos),t.DEFAULT_ZOOM=e.default_zoom||200,document.title=`Valheim WebMap - ${t.WORLD_NAME}`,((e="")=>{const t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.head.appendChild(t),t.sheet})(`\n\t\t.mapIcon.player {\n\t\t\ttransition: top ${t.UPDATE_INTERVAL}s linear, left ${t.UPDATE_INTERVAL}s linear;\n\t\t}\n\t\t.map.smooth {\n\t\t\ttransition: top ${t.UPDATE_INTERVAL}s linear, left ${t.UPDATE_INTERVAL}s linear;\n\t\t}\n\t`)}));(async()=>{s.init(),V(),await Promise.all([new Promise((e=>{fetch("map").then((e=>e.blob())).then((t=>{B.onload=e,B.src=URL.createObjectURL(t)}))})),new Promise((e=>{Y.onload=e,Y.src="fog"})),Z]),P({mapImage:B,fogImage:Y,zoom:t.DEFAULT_ZOOM}),N({type:"start",x:t.WORLD_START_POSITION.x,z:t.WORLD_START_POSITION.z});const e={};s.addActionListener("ping",(t=>{let n=e[t.playerId];n||(n={...t},n.type="ping",n.text=t.name,N(n,!1),e[t.playerId]=n),n.x=t.x,n.z=t.z,U(),clearTimeout(n.timeoutId),n.timeoutId=setTimeout((()=>{delete e[t.playerId],b(n)}),8e3)})),fetch("pins").then((e=>e.text())).then((e=>{e.split("\n").forEach((e=>{const t=e.split(",");if(t.length>5){const e={id:t[1],uid:t[0],type:t[2],name:t[3],x:t[4],z:t[5],text:t[6],static:!0};N(e,!1)}})),U()})),s.addActionListener("pin",(e=>{N(e)})),s.addActionListener("rmpin",(e=>{(e=>{const t=T.find((t=>t.id===e));t&&R(t)})(e)})),window.addEventListener("resize",(()=>{W()})),r.menuBtn.addEventListener("click",(()=>{r.menu.classList.toggle("menuOpen")}));const n=e=>{const t=e.target.closest(".menu"),n=e.target.closest(".menu-btn");t||n||r.menu.classList.remove("menuOpen")};window.addEventListener("mousedown",n),window.addEventListener("touchstart",n);const i=r.menu.querySelectorAll(".hideIconCheckbox");i.forEach((e=>{e.addEventListener("change",(()=>{F(e.dataset.hide,e.checked||r.hideAll.checked),"all"===e.dataset.hide&&i.forEach((t=>{F(t.dataset.hide,e.checked||t.checked)})),U()}))})),r.hidePlayerList.addEventListener("change",(()=>{r.hidePlayerList.checked?r.playerListContainer.style.right=-r.playerListContainer.offsetWidth+"px":r.playerListContainer.style.right=0}))})()})();